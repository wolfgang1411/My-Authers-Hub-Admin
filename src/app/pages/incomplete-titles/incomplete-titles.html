<div class="flex flex-col flex-grow gap-4">
  <h3 class="heading">
    {{ "incompleteTitles" | translate }}
  </h3>

  <!-- Filter buttons -->
  <div class="flex w-full gap-4">
    <button
      class="btn rounded-md !text-primary"
      type="button"
      matButton="filled"
      matButton
      [ngClass]="{
        '!bg-primary !text-white': filterType() === 'incomplete',
        '!bg-primary-superlight': filterType() !== 'incomplete'
      }"
      (click)="onFilterChange('incomplete')"
    >
      <mat-icon>warning</mat-icon>
      {{ "incompleteTitles" | translate }}
    </button>
    <button
      class="btn rounded-md !text-primary"
      type="button"
      matButton="filled"
      matButton
      [ngClass]="{
        '!bg-primary !text-white': filterType() === 'all',
        '!bg-primary-superlight': filterType() !== 'all'
      }"
      (click)="onFilterChange('all')"
    >
      <mat-icon>library_books</mat-icon>
      {{ "allTitles" | translate }}
    </button>
  </div>

  @if (isLoading()) {
    <div class="flex justify-center items-center py-8">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  } @else if (errorMessage()) {
    <div class="alert alert-error">
      {{ errorMessage() }}
    </div>
  } @else if (titles().length === 0) {
    <div class="text-center py-8">
      <p>{{ "noTitlesFound" | translate }}</p>
    </div>
  } @else {
    <div class="overflow-x-auto">
      <table mat-table [dataSource]="dataSource" class="w-full">
        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>
            {{ "name" | translate }}
          </th>
          <td mat-cell *matCellDef="let title">
            <a
              [routerLink]="['/titleSummary', title.id]"
              class="text-primary hover:underline"
            >
              {{ title.name }}
            </a>
          </td>
        </ng-container>

        <!-- Publishing Type Column -->
        <ng-container matColumnDef="publishingType">
          <th mat-header-cell *matHeaderCellDef>
            {{ "publishingType" | translate }}
          </th>
          <td mat-cell *matCellDef="let title">
            {{ getPublishingTypeLabel(title.publishingType) }}
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>
            {{ "status" | translate }}
          </th>
          <td mat-cell *matCellDef="let title">
            <span [class]="getStatusClass(title)">
              {{ getStatusText(title) }}
            </span>
          </td>
        </ng-container>

        <!-- Missing Details Column -->
        <ng-container matColumnDef="missingDetails">
          <th mat-header-cell *matHeaderCellDef>
            {{ "missingBasicDetails" | translate }}
          </th>
          <td mat-cell *matCellDef="let title">
            @if (title.missingBasicDetails && title.missingBasicDetails.length > 0) {
              <div class="flex flex-wrap gap-1">
                @for (detail of title.missingBasicDetails; track detail) {
                  <span class="badge badge-error">
                    {{ getMissingDetailsLabel([detail]) }}
                  </span>
                }
              </div>
            } @else {
              <span class="text-success">✓</span>
            }
          </td>
        </ng-container>

        <!-- Missing Media Column -->
        <ng-container matColumnDef="missingMedia">
          <th mat-header-cell *matHeaderCellDef>
            {{ "missingMedia" | translate }}
          </th>
          <td mat-cell *matCellDef="let title">
            @if (title.missingMedia && title.missingMedia.length > 0) {
              <div class="flex flex-wrap gap-1">
                @for (media of title.missingMedia; track media) {
                  <span class="badge badge-warning">
                    {{ getMissingMediaLabel([media]) }}
                  </span>
                }
              </div>
            } @else {
              <span class="text-success">✓</span>
            }
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>
            {{ "actions" | translate }}
          </th>
          <td mat-cell *matCellDef="let title">
            <div class="flex gap-2">
              <a
                [routerLink]="['/titleSummary', title.id]"
                class="btn btn-sm btn-primary"
              >
                {{ "view" | translate }}
              </a>
              @if (isSuperAdmin()) {
                <a
                  [routerLink]="['/title', title.id]"
                  [queryParams]="{ returnTo: 'incomplete-titles' }"
                  class="btn btn-sm btn-secondary"
                >
                  <mat-icon class="material-icons">edit</mat-icon>
                  {{ "edit" | translate }}
                </a>
                <button
                  type="button"
                  class="btn btn-sm btn-secondary"
                  (click)="openSkuAndLinks(title)"
                  [disabled]="isLoading()"
                >
                  <mat-icon class="material-icons">link</mat-icon>
                  {{ "skuandlinks" | translate }}
                </button>
              }
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>

    <!-- Pagination -->
    <div class="flex items-center justify-between gap-4 mt-4">
      <div class="flex items-center gap-2">
        <span class="text-sm text-[var(--text-secondary)]">
          {{ "page" | translate }} {{ page() }} {{ "of" | translate }} {{ totalPages() }}
        </span>
        <span class="text-sm text-[var(--text-secondary)]">|</span>
        <span class="text-sm text-[var(--text-secondary)]">{{ "itemsperpage" | translate }}:</span>
        <select
          class="px-2 py-1 border border-[var(--primary-superlight)] rounded-md text-sm"
          [value]="itemsPerPage()"
          (change)="onItemsPerPageChange(+$any($event.target).value)"
        >
          <option value="10">10</option>
          <option value="30">30</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <button
          class="btn btn-sm"
          [disabled]="page() <= 1"
          (click)="onPageChange(page() - 1)"
        >
          {{ "previous" | translate }}
        </button>
        <button
          class="btn btn-sm"
          [disabled]="page() >= totalPages()"
          (click)="onPageChange(page() + 1)"
        >
          {{ "next" | translate }}
        </button>
      </div>
    </div>
  }
</div>

