<div class="flex flex-col flex-grow gap-4">
  <div class="flex justify-between items-center">
    <h3 class="heading">
      {{ "missingmedias" | translate }}
    </h3>
    <app-back></app-back>
  </div>

  <div class="flex flex-col sm:flex-row justify-between w-full gap-4">
    <div
      class="flex flex-col sm:flex-row items-stretch gap-2 w-full lg:max-w-[520px]"
    >
      <input
        class="input-field outline-none sm:flex-1 min-w-0 w-full h-[38px]"
        #input
        (input)="searchStr.next(input.value)"
        [placeholder]="'search' | translate"
      />
      <button
        class="btn h-[38px] inline-flex items-center self-start justify-center gap-2 shrink-0 whitespace-nowrap"
        (click)="searchStr.next(input.value)"
      >
        <svg-icon
          src="images/magnifying-glass-solid-full.svg"
          class="w-4 fill-white flex"
        ></svg-icon>
        {{ "search" | translate }}
      </button>
    </div>
  </div>

  <!-- Desktop Table -->
  <div class="hidden lg:block pt-6">
    <app-list-table
      [dataSource]="dataSource"
      [displayedColumns]="displayedColumns"
      [isSortable]="isSortable"
      [cellTemplate]="cellTemplate"
      (sortChange)="onSortChange($event)"
    >
    </app-list-table>
  </div>
  <!-- Mobile Cards -->
  <div class="lg:hidden space-y-4 pt-4">
    @if (dataSource.data.length) {
      @for (element of dataSource.data; track element.id) {
        <div
          class="rounded-xl border border-primary-superlight bg-white p-4 shadow-sm"
        >
          <!-- Title + Publisher -->
          <div class="mb-2">
            <h4 class="text-sm font-semibold text-text-heading leading-snug">
              {{ element.name }}
            </h4>
            <p class="text-xs text-text-secondary">
              {{ element.publisher }}
            </p>
          </div>

          <!-- Available Media -->
          <div class="mt-3">
            <p
              class="text-xs font-semibold uppercase tracking-wide text-text-secondary"
            >
              {{ "availablemedia" | translate }}
            </p>

            @if (element.availablemedia?.length) {
              <div class="mt-2 flex flex-wrap gap-2">
                @for (item of element.availablemedia; track $index) {
                  <button
                    mat-icon-button
                    class="!bg-primary !text-white"
                    (click)="downloadMedia(element.id, item.type)"
                    [title]="item.type | translate"
                  >
                    <mat-icon>{{ getIconByMedia(item.type) }}</mat-icon>
                  </button>
                }
              </div>
            } @else {
              <p class="mt-1 text-xs text-text-secondary italic">—</p>
            }
          </div>

          <!-- Missing Media -->
          <div class="mt-4">
            <p
              class="text-xs font-semibold uppercase tracking-wide text-text-secondary"
            >
              {{ "missingmedia" | translate }}
            </p>

            @if (element.missingmedia?.length) {
              <div class="mt-2 flex flex-wrap gap-2">
                @for (media of element.missingmedia; track $index) {
                  <button
                    mat-icon-button
                    class="!bg-primary !text-white"
                    (click)="uploadMedia(element.id, media)"
                    [title]="media | translate"
                  >
                    <mat-icon>{{ getIconByMedia(media) }}</mat-icon>
                  </button>
                }
              </div>
            } @else {
              <p class="mt-1 text-xs text-text-secondary italic">—</p>
            }
          </div>
        </div>
      }
    } @else {
      <p class="text-center text-sm text-text-secondary italic">
        No records found
      </p>
    }
  </div>

  <div class="flex items-center justify-between gap-4 mt-4">
    <div class="flex items-center gap-2">
      <span class="text-sm text-[var(--text-secondary)]">
        {{ "page" | translate }} {{ filter().page || 1 }} {{ "of" | translate }}
        {{ lastPage() }}
      </span>
      <span class="text-sm text-[var(--text-secondary)]">|</span>
      <span class="text-sm text-[var(--text-secondary)]"
        >{{ "itemsperpage" | translate }}:</span
      >
      <select
        class="px-2 py-1 border border-[var(--primary-superlight)] rounded-md text-sm"
        [value]="filter().itemsPerPage || 30"
        (change)="onItemsPerPageChange(+$any($event.target).value)"
      >
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="30">30</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </div>
    @if (lastPage() > 1) {
      <div class="flex items-center gap-2">
        <button
          class="btn rounded-md !text-primary"
          matButton="filled"
          matButton
          type="button"
          [disabled]="(filter().page || 1) === 1"
          (click)="prevPage()"
        >
          <mat-icon>chevron_left</mat-icon>
          {{ "previous" | translate }}
        </button>
        <div class="flex items-center gap-1">
          @for (pageNum of getPageNumbers(); track pageNum) {
            @if (pageNum === -1) {
              <span class="px-2 text-[var(--text-secondary)]">...</span>
            } @else {
              <button
                class="btn rounded-md !text-primary min-w-[40px]"
                matButton="filled"
                matButton
                type="button"
                [ngClass]="{
                  '!bg-primary !text-white': (filter().page || 1) === pageNum,
                  '!bg-primary-superlight': (filter().page || 1) !== pageNum,
                }"
                (click)="goToPage(pageNum)"
              >
                {{ pageNum }}
              </button>
            }
          }
        </div>
        <button
          class="btn rounded-md !text-primary"
          matButton="filled"
          matButton
          type="button"
          [disabled]="(filter().page || 1) === lastPage()"
          (click)="nextPage()"
        >
          {{ "next" | translate }}
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    }
  </div>

  <ng-template #cellTemplate let-element let-column="column">
    @switch (column) {
      @case ("name") {
        {{ element.name }}
      }
      @case ("publisher") {
        {{ element.publisher }}
      }

      @case ("availablemedia") {
        <div class="flex gap-2">
          @for (item of element.availablemedia; track $index) {
            <button
              class="!bg-primary !text-white"
              mat-icon-button
              aria-label="Download media"
              (click)="downloadMedia(element.id, item.type)"
              [title]="item.type | translate"
            >
              <mat-icon>{{ getIconByMedia(item.type) }}</mat-icon>
            </button>
          }
        </div>
      }
      @case ("missingmedia") {
        <div class="flex justify-end gap-2">
          @for (media of element.missingmedia; track $index) {
            <button
              class="!bg-primary !text-white"
              mat-icon-button
              aria-label="Upload media"
              [title]="media | translate"
              (click)="uploadMedia(element.id, media)"
            >
              <mat-icon>{{ getIconByMedia(media) }}</mat-icon>
            </button>
          }
        </div>
      }
    }
  </ng-template>
</div>
