<div class="flex flex-col gap-8 mt-8">
  <!-- ========== PRICING SECTION ========== -->
  <div class="flex flex-col gap-4 mt-8">
    <div>
      <h2 class="font-medium text-lg">
        MSP :
        {{ (msp() | currency) || "N/A" }}
      </h2>
      <h2 class="font-medium text-lg">
        Printing Price :
        {{ (printingPrice() | currency) || "N/A" }}
      </h2>
      <p>
        Sales price and MRP cannot be lower than MSP and Sales Price cannot be
        greater than MRP. Note: MSP is {{ ebookMsp() }} for ebook platforms
        (MAH_EBOOK, KINDLE, GOOGLE_PLAY) and calculated for other platforms.
      </p>
    </div>

    <ul class="pricing-container">
      <li class="flex">
        <span></span>
        @for (item of pricingControls().controls; track $index) {
        <span>{{ item.controls.platform.value | translate }}</span>
        }
      </li>
      <li>
        <span>MRP</span>
        @for (item of pricingControls().controls; track $index) {
        <span>
          <input
            [formControl]="item.controls.mrp"
            type="text"
            [placeholder]="'entermrp' | translate"
          />
        </span>
        }
      </li>
      <li>
        <span>Sales Price</span>
        @for (item of pricingControls().controls; track $index) {
        <span>
          <input
            [formControl]="item.controls.salesPrice"
            type="text"
            [placeholder]="'salesprice' | translate"
          />
        </span>
        }
      </li>
    </ul>
  </div>

  <!-- ========== ROYALTY SECTION ========== -->
  @if (authors().length > 0 || publisher()) {
  <div class="flex flex-col gap-4 border-t pt-8">
    <h2 class="text-xl font-semibold mb-4">{{ "royalty" | translate }}</h2>

    <!-- Author Royalties -->
    @if (authors().length > 0) {
    <div class="flex flex-col gap-4">
      <h3 class="text-lg font-medium">{{ "authorroyalties" | translate }}</h3>

      <div class="flex flex-col gap-3">
        @for (author of authors(); track author.id) {
        <div class="flex items-center gap-4 p-4 border rounded-lg bg-gray-50">
          <div class="flex-1">
            <label class="block text-sm font-medium mb-1">
              {{
                author.name ||
                  author.user?.firstName + " " + author.user?.lastName
              }}
            </label>
            <p class="text-xs text-gray-500">
              Percentage applied to all platforms
            </p>
          </div>
          <div class="w-32 flex items-center gap-1">
            <input
              [formControl]="getAuthorPercentageControl(author.id)"
              type="number"
              min="0"
              max="100"
              step="1"
              placeholder="0"
              class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
              (keydown)="
                $event.key === '.' || $event.key === ','
                  ? $event.preventDefault()
                  : null
              "
            />
            <span class="text-sm text-gray-600">%</span>
          </div>
        </div>
        }
      </div>
    </div>
    }

    <!-- Publisher Royalty (Auto-calculated) -->
    @if (publisher()) {
    <div class="flex flex-col gap-2 p-4 border rounded-lg bg-blue-50">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-lg font-medium">
            {{
              publisher()?.name ||
                publisher()?.user?.firstName + " " + publisher()?.user?.lastName
            }}
            <span class="text-sm font-normal text-gray-600"
              >({{ "publisher" | translate }})</span
            >
          </h3>
          <p class="text-xs text-gray-500 mt-1">
            Automatically calculated: 100% - Total Author Percentages
          </p>
        </div>
        <div class="text-right">
          <div class="text-2xl font-bold text-blue-600">
            {{ publisherPercentage() | number : "1.2-2" }}%
          </div>
          <p class="text-xs text-gray-500">Applied to all platforms</p>
        </div>
      </div>
    </div>
    }

    <!-- Total Percentages Summary -->
    <div
      class="flex items-center justify-between p-4 border rounded-lg bg-gray-100"
    >
      <div>
        <span class="font-medium">Total Author Percentages:</span>
        <span class="ml-2"
          >{{ getTotalAuthorPercentages() | number : "1.2-2" }}%</span
        >
      </div>
      <div>
        <span class="font-medium">Publisher Percentage:</span>
        <span class="ml-2"
          >{{ publisherPercentage() | number : "1.2-2" }}%</span
        >
      </div>
      <div>
        <span class="font-medium">Total:</span>
        <span
          class="ml-2"
          [ngClass]="{
            'text-red-600 font-bold':
              getTotalAuthorPercentages() + publisherPercentage() !== 100,
            'text-green-600 font-bold':
              getTotalAuthorPercentages() + publisherPercentage() === 100
          }"
        >
          {{
            getTotalAuthorPercentages() + publisherPercentage()
              | number : "1.2-2"
          }}%
        </span>
      </div>
      @if (royaltiesController().getError('invalid')) {
      <p class="text-sm text-red-600 mt-2">
        {{ royaltiesController().getError("invalid") }}
      </p>
      }
    </div>

    <!-- Calculations Section -->
    @if (displayedColumns().length > 0 && pricingControls().controls.length > 0)
    {
    <div class="flex flex-col gap-2 mt-4">
      <h3 class="text-lg font-medium">Royalty Amount Calculations</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full border-collapse border border-gray-300">
          <thead>
            <tr class="bg-gray-100">
              <th class="border border-gray-300 px-4 py-2 text-left">Name</th>
              @for (platform of displayedColumns(); track platform) {
              <th class="border border-gray-300 px-4 py-2 text-center">
                {{ platform | translate }}
              </th>
              }
            </tr>
          </thead>
          <tbody>
            @for (author of authors(); track author.id) {
            <tr>
              <td class="border border-gray-300 px-4 py-2 font-medium">
                {{
                  author.name ||
                    author.user?.firstName + " " + author.user?.lastName
                }}
              </td>
              @for (platform of displayedColumns(); track platform) {
              <td class="border border-gray-300 px-4 py-2 text-center">
                {{ (totalRoyaltiesAmount()['author' + author.id]?.[platform] || 0) | currency }}
              </td>
              }
            </tr>
            } @if (publisher()) {
            <tr class="bg-blue-50">
              <td class="border border-gray-300 px-4 py-2 font-medium">
                {{
                  publisher()?.name ||
                    publisher()?.user?.firstName +
                      " " +
                      publisher()?.user?.lastName
                }}
                <span class="text-xs text-gray-500">(Publisher)</span>
              </td>
              @for (platform of displayedColumns(); track platform) {
              <td
                class="border border-gray-300 px-4 py-2 text-center font-medium"
              >
                {{ (totalRoyaltiesAmount()['publisher' + publisher()?.id]?.[platform] || 0) | currency }}
              </td>
              }
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
    }
  </div>
  }
</div>
