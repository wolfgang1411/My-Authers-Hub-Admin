<div class="flex flex-col flex-grow gap-3 sm:gap-4">
  <nav class="flex flex-col gap-3 sm:gap-6 sticky z-10 py-3 sm:py-4">
    <div
      class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2"
    >
      <h3 class="heading">{{ "authorDetails" | translate }}</h3>
      <app-back></app-back>
    </div>
  </nav>
  <ng-template #authorDetailsTpl>
    <section
      class="mt-5 sm:mt-8 bg-white p-4 sm:p-6 lg:p-8 rounded-xl shadow-md mat-elevation-z4"
    >
      <!-- ================= HEADER ================= -->
      <div
        class="flex flex-col sm:flex-row items-center sm:items-start gap-4 sm:gap-6 pb-5 sm:pb-6 border-b"
      >
        <!-- Profile Image -->
        <div
          class="w-24 h-24 sm:w-28 sm:h-28 rounded-full overflow-hidden shadow border flex items-center justify-center"
        >
          @if (
            authorDetails() &&
            authorDetails()?.medias &&
            authorDetails()?.medias?.length
          ) {
            <img
              [src]="
                authorDetails()?.medias?.[0]?.url ??
                  'images/user-solid-full.svg' | safeUrl
              "
              class="w-full h-full object-cover"
            />
          }
          @if (!authorDetails()?.medias?.length) {
            <img
              src="images/user-solid-full.svg"
              class="w-16 h-16 opacity-60"
            />
          }
        </div>

        <!-- Title -->
        <div>
          <h2
            class="text-lg sm:text-xl lg:text-2xl font-medium text-text-heading capitalize"
          >
            {{ authorDetails()?.user?.firstName }}
            {{ authorDetails()?.user?.lastName }}
          </h2>

          <p class="text-gray-500 text-sm mt-1">
            {{ authorDetails()?.username || "No Username" }}
          </p>

          <p class="text-gray-600 text-sm mt-1">
            {{ authorDetails()?.email }}
          </p>
        </div>
      </div>

      <!-- ================= AUTHOR DETAILS ================= -->
      <div class="mt-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
          {{ "authorDetails" | translate }}
        </h3>

        <div
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 text-sm"
        >
          <div>
            <span class="font-medium">Username:</span>
            {{ authorDetails()?.username }}
          </div>
          <!-- <div>
              <span class="font-medium">Official Email:</span>
              {{ authorDetails()?.email }}
            </div> -->
          <div>
            <span class="font-medium">Author Name:</span>
            {{ authorDetails()?.user?.firstName }}
            {{ authorDetails()?.user?.lastName }}
          </div>

          <div>
            <span class="font-medium">Contact Number:</span>
            {{ authorDetails()?.user?.phoneNumber }}
          </div>
          <div>
            <span class="font-medium">Email ID:</span>
            {{ authorDetails()?.user?.email }}
          </div>

          <div class="col-span-2">
            <span class="font-medium">Address:</span> {{ completeAddress() }}
          </div>
        </div>
      </div>

      <!-- ================= BANK DETAILS ================= -->
      <div class="mt-10">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
          {{ "bankdetails" | translate }}
        </h3>

        <div
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 text-sm"
        >
          <div>
            <span class="font-medium">Bank Name:</span>
            {{ authorDetails()?.bankDetails?.[0]?.name || "Not Provided" }}
          </div>
          <div>
            <span class="font-medium">Account Number:</span>
            {{ authorDetails()?.bankDetails?.[0]?.accountNo }}
          </div>
          <div>
            <span class="font-medium">IFSC Code:</span>
            {{ authorDetails()?.bankDetails?.[0]?.ifsc }}
          </div>
          <div>
            <span class="font-medium">Account Type:</span>
            {{ authorDetails()?.bankDetails?.[0]?.accountType }}
          </div>
          <div>
            <span class="font-medium">PAN Number:</span>
            {{ authorDetails()?.bankDetails?.[0]?.panCardNo }}
          </div>
        </div>
      </div>
    </section>
  </ng-template>
  <ng-template #booksTpl>
    <section
      id="books-published"
      class="mt-6 sm:mt-10 bg-white p-4 sm:p-6 rounded-xl shadow"
    >
      <div
        class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3"
      >
        <h2 class="heading mb-4">{{ "bookspublished" | translate }}</h2>
        <mat-form-field>
          <mat-label>{{ "filter" | translate }}</mat-label>
          <input
            matInput
            (keyup)="applyFilter($event)"
            placeholder="Ex. ium"
            #input
          />
        </mat-form-field>
      </div>
      <!-- DESKTOP TABLE -->
      <div class="hidden md:block overflow-x-auto">
        <app-list-table
          class="pt-6"
          [dataSource]="bookPublishData"
          [displayedColumns]="displayedColumns"
          [isSortable]="booksIsSortable"
          (sortChange)="booksOnSortChange($event)"
        >
        </app-list-table>
      </div>
      <div class="md:hidden flex flex-col gap-4 pt-4">
        @for (book of bookPublishData.data; track book.id) {
          <div class="bg-white border rounded-xl p-4 shadow-sm space-y-4">
            <!-- Title -->
            <div>
              <p class="text-xs text-gray-400">
                {{ "title" | translate }}
              </p>
              <h4 class="font-semibold text-gray-800 leading-snug">
                {{ book.title }}
              </h4>
            </div>

            <!-- ISBNs -->
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div>
                <p class="text-gray-400">ISBN (Print)</p>
                <p class="break-all">{{ book.isbnPrint }}</p>
              </div>

              <div>
                <p class="text-gray-400">ISBN (E-Book)</p>
                <p class="break-all">{{ book.isbnEbook }}</p>
              </div>
            </div>

            <!-- Distribution + Pages -->
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div>
                <p class="text-gray-400">Distribution</p>
                <p>{{ book.distribution }}</p>
              </div>

              <div>
                <p class="text-gray-400">Pages</p>
                <p>{{ book.pages }}</p>
              </div>
            </div>

            <!-- Authors -->
            <div class="text-sm">
              <p class="text-gray-400">Authors</p>
              <p class="leading-snug">{{ book.authors }}</p>
            </div>

            <!-- Royalties -->
            <div
              class="flex items-center justify-between pt-2 border-t text-sm"
            >
              <span class="text-gray-500">
                {{ "royaltiesearned" | translate }}
              </span>
              <span class="font-semibold text-primary">
                {{ book.royaltiesearned | currency: "INR" }}
              </span>
            </div>
          </div>
        }

        <!-- Empty State -->
        @if (!bookPublishData.data.length) {
          <div class="text-center text-sm text-gray-500 py-6">
            {{ "norecordsfound" | translate }}
          </div>
        }
      </div>

      <div class="flex items-center justify-between gap-4 mt-4">
        <div class="flex items-center gap-2">
          <span class="text-sm text-[var(--text-secondary)]">
            {{ "page" | translate }} {{ booksFilter().page || 1 }}
            {{ "of" | translate }} {{ booksLastPage() }}
          </span>
          <span class="text-sm text-[var(--text-secondary)]">|</span>
          <span class="text-sm text-[var(--text-secondary)]"
            >{{ "itemsperpage" | translate }}:</span
          >
          <select
            class="px-2 py-1 border border-[var(--primary-superlight)] rounded-md text-sm"
            [value]="booksFilter().itemsPerPage || 30"
            (change)="booksOnItemsPerPageChange(+$any($event.target).value)"
          >
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="30">30</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        @if (booksLastPage() > 1) {
          <div class="flex items-center gap-2">
            <button
              class="btn rounded-md !text-primary"
              matButton="filled"
              matButton
              type="button"
              [disabled]="(booksFilter().page || 1) === 1"
              (click)="booksPreviousPage()"
            >
              <mat-icon>chevron_left</mat-icon>
              {{ "previous" | translate }}
            </button>
            <div class="flex items-center gap-1">
              @for (pageNum of booksGetPageNumbers(); track pageNum) {
                @if (pageNum === -1) {
                  <span class="px-2 text-[var(--text-secondary)]">...</span>
                } @else {
                  <button
                    class="btn rounded-md !text-primary min-w-[40px]"
                    matButton="filled"
                    matButton
                    type="button"
                    [ngClass]="{
                      '!bg-primary !text-white':
                        (booksFilter().page || 1) === pageNum,
                      '!bg-primary-superlight':
                        (booksFilter().page || 1) !== pageNum,
                    }"
                    (click)="booksGoToPage(pageNum)"
                  >
                    {{ pageNum }}
                  </button>
                }
              }
            </div>
            <button
              class="btn rounded-md !text-primary"
              matButton="filled"
              matButton
              type="button"
              [disabled]="(booksFilter().page || 1) === booksLastPage()"
              (click)="booksNextPage()"
            >
              {{ "next" | translate }}
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>
        }
      </div>
    </section>
  </ng-template>
  <ng-template #royaltiesTpl>
    <section
      id="royalties"
      class="mt-6 sm:mt-10 bg-white p-4 sm:p-6 rounded-xl shadow flex flex-col gap-4 sm:gap-6"
    >
      <div
        class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3"
      >
        <h2 class="heading">{{ "Royalties&Wallet" | translate }}</h2>
        <mat-form-field>
          <mat-label>{{ "filter" | translate }}</mat-label>
          <input
            matInput
            (keyup)="applyRoyaltyFilter($event)"
            placeholder="Ex. ium"
            #input
          />
        </mat-form-field>
      </div>
      <div class="flex justify-between">
        <ul class="space-y-2">
          <li>
            <div>
              ü™ô {{ "walletbalance" | translate }} :
              <label class="font-medium">{{
                (authorDetails()?.user?.wallet?.totalAmount || 0) -
                  (authorDetails()?.user?.wallet?.holdAmount || 0)
                  | currency: "INR"
              }}</label>
            </div>
          </li>
          <li>
            ‚è≥{{ "onhold" | translate }} :
            <label class="font-medium">{{
              authorDetails()?.user?.wallet?.holdAmount || 0 | currency: "INR"
            }}</label>
          </li>
        </ul>
        @if (
          ["SUPERADMIN", "PUBLISHER"].includes(
            loggedInUser()?.accessLevel || ""
          )
        ) {
          <div>
            <button
              (click)="onClickAddWalletAmount()"
              color="primary"
              mat-raised-button
            >
              {{ "addwalletamount" | translate }}
            </button>
          </div>
        }
      </div>

      <!-- DESKTOP -->
      <div class="hidden md:block overflow-x-auto">
        <app-list-table
          [dataSource]="royaltyData"
          [displayedColumns]="displayedRoyaltyColumns()"
          [isSortable]="royaltyIsSortable"
          (sortChange)="royaltyOnSortChange($event)"
        >
        </app-list-table>
      </div>
      <div class="md:hidden flex flex-col gap-4 pt-4">
        @for (item of rawRoyalties(); track item.id) {
          <div class="bg-white border rounded-xl p-4 shadow-sm space-y-3">
            <!-- TITLE -->
            <h4 class="font-semibold text-gray-800">
              {{ item.royalty.title.name }}
            </h4>

            <!-- PUBLISHER / AUTHOR -->
            <p class="text-xs text-[var(--text-secondary)] mt-1">
              <span class="font-medium">Publisher / Author:</span>
              {{
                item.royalty.publisher?.name ||
                  item.royalty.author?.user?.firstName ||
                  "N/A"
              }}
            </p>

            <!-- PLATFORM -->
            <p class="text-sm">
              <span class="text-gray-400">Platform:</span>
              {{ item.platformName || (item.platform.name | translate) }}
            </p>

            <!-- AMOUNT -->
            <p class="text-sm font-medium text-[var(--text-primary)]">
              {{ item.amount | currency: "INR" }}
            </p>

            <!-- DATE -->
            <div class="grid grid-cols-2 gap-3 text-sm pt-2">
              <div>
                <p class="text-[var(--text-secondary)]">Hold Until</p>
                <p class="font-medium text-[var(--text-primary)]">
                  {{
                    item.holdUntil ? (item.holdUntil | date: "dd-MM-yyyy") : "-"
                  }}
                </p>
              </div>

              <div>
                <p class="text-[var(--text-secondary)]">Paid At</p>
                <p class="font-medium text-[var(--text-primary)]">
                  {{ item.paidAt ? (item.paidAt | date: "dd-MM-yyyy") : "-" }}
                </p>
              </div>
            </div>
          </div>
        }
      </div>

      <div class="flex items-center justify-between gap-4 mt-4">
        <div class="flex items-center gap-2">
          <span class="text-sm text-[var(--text-secondary)]">
            {{ "page" | translate }} {{ royaltyFilter().page || 1 }}
            {{ "of" | translate }} {{ royaltyLastPage() }}
          </span>
          <span class="text-sm text-[var(--text-secondary)]">|</span>
          <span class="text-sm text-[var(--text-secondary)]"
            >{{ "itemsperpage" | translate }}:</span
          >
          <select
            class="px-2 py-1 border border-[var(--primary-superlight)] rounded-md text-sm"
            [value]="royaltyFilter().itemsPerPage || 30"
            (change)="royaltyOnItemsPerPageChange(+$any($event.target).value)"
          >
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="30">30</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        @if (royaltyLastPage() > 1) {
          <div class="flex items-center gap-2">
            <button
              class="btn rounded-md !text-primary"
              matButton="filled"
              matButton
              type="button"
              [disabled]="(royaltyFilter().page || 1) === 1"
              (click)="royaltyPreviousPage()"
            >
              <mat-icon>chevron_left</mat-icon>
              {{ "previous" | translate }}
            </button>
            <div class="flex items-center gap-1">
              @for (pageNum of royaltyGetPageNumbers(); track pageNum) {
                @if (pageNum === -1) {
                  <span class="px-2 text-[var(--text-secondary)]">...</span>
                } @else {
                  <button
                    class="btn rounded-md !text-primary min-w-[40px]"
                    matButton="filled"
                    matButton
                    type="button"
                    [ngClass]="{
                      '!bg-primary !text-white':
                        (royaltyFilter().page || 1) === pageNum,
                      '!bg-primary-superlight':
                        (royaltyFilter().page || 1) !== pageNum,
                    }"
                    (click)="royaltyGoToPage(pageNum)"
                  >
                    {{ pageNum }}
                  </button>
                }
              }
            </div>
            <button
              class="btn rounded-md !text-primary"
              matButton="filled"
              matButton
              type="button"
              [disabled]="(royaltyFilter().page || 1) === royaltyLastPage()"
              (click)="royaltyNextPage()"
            >
              {{ "next" | translate }}
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>
        }
      </div>
    </section>
  </ng-template>
  <ng-template #publishedLinksTpl>
    <section
      id="published-links"
      class="mt-6 sm:mt-10 bg-white p-4 sm:p-6 rounded-xl shadow"
    >
      <div
        class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-4"
      >
        <h2 class="heading">{{ "publishedlinks" | translate }}</h2>
        <mat-form-field class="w-64">
          <mat-label>{{ "search" | translate }}</mat-label>
          <input
            matInput
            #searchInput
            [placeholder]="'search' | translate"
            (keyup)="onPublishedLinksSearch(searchInput.value)"
          />
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>
      </div>
      <div class="hidden md:block overflow-x-auto">
        <app-list-table
          class="pt-6"
          [dataSource]="publishedLinksData"
          [displayedColumns]="displayedPublishedLinksColumns"
          [actionTemplate]="publishedLinksActionButtons"
          [isSortable]="publishedLinksIsSortable"
          (sortChange)="publishedLinksOnSortChange($event)"
        >
        </app-list-table>
      </div>

      <!-- MOBILE VIEW : PUBLISHED LINKS -->
      <div class="md:hidden flex flex-col gap-4 pt-4">
        @for (item of publishedLinksData.data; track item.title) {
          <div class="bg-white border rounded-xl shadow-sm p-4 space-y-4">
            <!-- Title -->
            <div>
              <p class="text-xs text-gray-400">
                {{ "title" | translate }}
              </p>
              <h4 class="font-medium text-gray-800 break-words">
                {{ item.title }}
              </h4>
            </div>

            <!-- Platform Links -->
            <div class="flex flex-wrap gap-2">
              @for (link of item.links; track link.link) {
                <a
                  [href]="link.link"
                  target="_blank"
                  class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-primary/10 text-primary hover:bg-primary/20 transition"
                >
                  <!-- Platform Icon -->
                  @if (hasPlatformIconUrl(link.platformName)) {
                    <img
                      [src]="getPlatformIconUrl(link.platformName)! | safeUrl"
                      class="w-4 h-4 object-contain"
                    />
                  } @else {
                    <mat-icon class="!text-sm">
                      {{ getPlatformIcon(link.platformName) }}
                    </mat-icon>
                  }

                  {{ link.platformName.replace("_", " ") }}
                </a>
              }
            </div>
          </div>
        }

        <!-- Empty State -->
        @if (!publishedLinksData.data.length) {
          <div class="text-center text-sm text-gray-500 py-6">
            {{ "norecordsfound" | translate }}
          </div>
        }
      </div>

      <ng-template #publishedLinksActionButtons let-element>
        <div class="flex flex-wrap gap-2">
          @for (linkItem of element.links; track linkItem.link) {
            <a
              target="_blank"
              [href]="linkItem.link"
              [matTooltip]="linkItem.platformName.replace('_', ' ')"
              class="inline-flex items-center gap-1.5 px-2.5 py-1.5 bg-[var(--primary-superlight)] hover:bg-[var(--primary-light)] text-[var(--primary)] rounded-lg text-sm transition-colors border border-transparent hover:border-[var(--primary-light)]"
            >
              @if (hasPlatformIconUrl(linkItem.platformName)) {
                <img
                  [src]="getPlatformIconUrl(linkItem.platformName)! | safeUrl"
                  [alt]="linkItem.platformName"
                  class="w-4 h-4 object-contain"
                />
              } @else {
                <mat-icon class="!text-base !w-4 !h-4">{{
                  getPlatformIcon(linkItem.platformName)
                }}</mat-icon>
              }
              <span class="font-medium">{{
                linkItem.platformName.replace("_", " ")
              }}</span>
            </a>
          }
        </div>
      </ng-template>

      <div class="flex items-center justify-between gap-4 mt-4">
        <div class="flex items-center gap-2">
          <span class="text-sm text-[var(--text-secondary)]">
            {{ "page" | translate }} {{ publishedLinksFilter().page || 1 }}
            {{ "of" | translate }} {{ publishedLinksLastPage() }}
          </span>
          <span class="text-sm text-[var(--text-secondary)]">|</span>
          <span class="text-sm text-[var(--text-secondary)]"
            >{{ "itemsperpage" | translate }}:</span
          >
          <select
            class="px-2 py-1 border border-[var(--primary-superlight)] rounded-md text-sm"
            [value]="publishedLinksFilter().itemsPerPage || 30"
            (change)="
              publishedLinksOnItemsPerPageChange(+$any($event.target).value)
            "
          >
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="30">30</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        @if (publishedLinksLastPage() > 1) {
          <div class="flex items-center gap-2">
            <button
              class="btn rounded-md !text-primary"
              matButton="filled"
              matButton
              type="button"
              [disabled]="(publishedLinksFilter().page || 1) === 1"
              (click)="publishedLinksPreviousPage()"
            >
              <mat-icon>chevron_left</mat-icon>
              {{ "previous" | translate }}
            </button>
            <div class="flex items-center gap-1">
              @for (pageNum of publishedLinksGetPageNumbers(); track pageNum) {
                @if (pageNum === -1) {
                  <span class="px-2 text-[var(--text-secondary)]">...</span>
                } @else {
                  <button
                    class="btn rounded-md !text-primary min-w-[40px]"
                    matButton="filled"
                    matButton
                    type="button"
                    [ngClass]="{
                      '!bg-primary !text-white':
                        (publishedLinksFilter().page || 1) === pageNum,
                      '!bg-primary-superlight':
                        (publishedLinksFilter().page || 1) !== pageNum,
                    }"
                    (click)="publishedLinksGoToPage(pageNum)"
                  >
                    {{ pageNum }}
                  </button>
                }
              }
            </div>
            <button
              class="btn rounded-md !text-primary"
              matButton="filled"
              matButton
              type="button"
              [disabled]="
                (publishedLinksFilter().page || 1) === publishedLinksLastPage()
              "
              (click)="publishedLinksNextPage()"
            >
              {{ "next" | translate }}
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>
        }
      </div>
    </section>
  </ng-template>
  <!-- DESKTOP VIEW -->
  <div class="hidden md:block">
    <mat-tab-group dynamicHeight>
      <!-- Author Details -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span class="text-text-heading font-medium">
            {{ "authorDetails" | translate }}
          </span>
        </ng-template>
        <ng-container *ngTemplateOutlet="authorDetailsTpl"></ng-container>
      </mat-tab>

      <!-- Books Published -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span class="text-text-heading font-medium">
            {{ "bookspublished" | translate }}
          </span>
        </ng-template>
        <ng-container *ngTemplateOutlet="booksTpl"></ng-container>
      </mat-tab>

      <!-- Royalties -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span class="text-text-heading font-medium">
            {{ "royalties&wallet" | translate }}
          </span>
        </ng-template>
        <ng-container *ngTemplateOutlet="royaltiesTpl"></ng-container>
      </mat-tab>

      <!-- Published Links -->
      <mat-tab>
        <ng-template mat-tab-label>
          <span class="text-text-heading font-medium">
            {{ "publishedlinks" | translate }}
          </span>
        </ng-template>
        <ng-container *ngTemplateOutlet="publishedLinksTpl"></ng-container>
      </mat-tab>
    </mat-tab-group>
  </div>

  <!-- MOBILE VIEW -->
  <div class="md:hidden flex flex-col gap-6">
    <app-mobile-section
      id="author-details"
      title="{{ 'authorDetails' | translate }}"
    >
      <ng-container *ngTemplateOutlet="authorDetailsTpl"></ng-container>
    </app-mobile-section>

    <app-mobile-section
      id="books-published"
      title="{{ 'bookspublished' | translate }}"
    >
      <ng-container *ngTemplateOutlet="booksTpl"></ng-container>
    </app-mobile-section>

    <app-mobile-section
      id="royalties"
      title="{{ 'royalties&wallet' | translate }}"
    >
      <ng-container *ngTemplateOutlet="royaltiesTpl"></ng-container>
    </app-mobile-section>

    <app-mobile-section
      id="published-links"
      title="{{ 'publishedlinks' | translate }}"
    >
      <ng-container *ngTemplateOutlet="publishedLinksTpl"></ng-container>
    </app-mobile-section>
  </div>
</div>
