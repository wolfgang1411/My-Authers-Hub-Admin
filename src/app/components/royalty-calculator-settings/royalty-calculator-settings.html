<section class="card">
  <div class="card-header">
    <div>
      <h2 class="heading">Royalty calculator</h2>
      <p class="sub-heading">
        Estimate payouts per platform using the shared royalty API.
      </p>
    </div>
    <button
      type="button"
      class="btn-secondary"
      (click)="addItem()"
      aria-label="Add platform row"
    >
      Add platform row
    </button>
  </div>

  <form class="form" [formGroup]="calculatorForm" (ngSubmit)="onCalculate()">
    <div class="grid gap-4 md:grid-cols-3">
      <label class="form-field">
        <span>Printing cost (per unit)</span>
        <input
          type="number"
          min="0"
          placeholder="0"
          formControlName="printingPrice"
          name="Printing Price"
          appInputError
          [isActive]="isSubmitted"
        />
      </label>
    </div>

    <div class="space-y-4" formArrayName="items">
      @for (group of royaltyItems.controls; track $index; let idx = $index) {
        <div class="platform-row items-start" [formGroupName]="idx">
          <label class="form-field">
            <span>Platform</span>
            <select
              formControlName="platform"
              (change)="validateMRP(idx)"
              name="Platform"
              required
              appInputError
              [isActive]="isSubmitted"
            >
              <option value="" disabled>Select platform</option>
              @for (platform of platforms(); track platform.id) {
                <option [value]="platform.name">{{ platform.name }}</option>
              }
            </select>
          </label>

          <label class="form-field items-start">
            <span>MRP</span>
            <input
              class="w-full"
              type="number"
              placeholder="0"
              formControlName="price"
              (input)="validateMRP(idx)"
              name="Price"
              required
              appInputError
              [isActive]="isSubmitted"
            />
            @if (royaltyItems.at(idx).get("price")?.errors?.["invalidMRP"]) {
              <p class="text-xs text-red-600 mt-1 font-medium">
                MRP must be greater than or equal to Printing Price for
                non-ebook platforms.
              </p>
            }
          </label>

          <label class="form-field">
            <span>Division % list</span>
            <input
              type="text"
              placeholder="e.g. 10, 90"
              formControlName="division"
              name="Division"
              required
              appInputError
              [isActive]="isSubmitted"
            />
          </label>
          <label class="form-field">
            <span>&nbsp;</span>
            <button
              type="button"
              class="btn-danger"
              (click)="removeItem(idx)"
              aria-label="Remove platform row"
            >
              Remove
            </button>
          </label>
        </div>
      }
    </div>

    <div class="actions">
      <button class="btn-primary" type="submit" [disabled]="isCalculating()">
        {{ isCalculating() ? "Calculating…" : "Calculate Royalties" }}
      </button>
    </div>
  </form>

  @if (resultDivision().length) {
    <div class="result">
      <h3 class="heading-sm">Latest calculation</h3>
      <div class="result-grid">
        @for (item of resultDivision(); track item.platformId) {
          <div class="result-card">
            <div class="result-header">
              <span class="platform-name">{{ item.platformId }}</span>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Division %</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody>
                @for (
                  entry of divisionRows(item.platformId, item.divisionValue);
                  track entry.id
                ) {
                  <tr>
                    <td>{{ entry.percentage }}%</td>
                    <td>₹ {{ entry.amount | number: "1.2-2" }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    </div>
  }
</section>

@if (isSuperAdmin()) {
  <section class="card">
    <div class="card-header">
      <div>
        <h2 class="heading">Platform manager</h2>
        <p class="sub-heading">
          Create or update active platforms. Only Super Admins can save changes.
        </p>
      </div>
      <button
        type="button"
        matButton="filled"
        class="btn-primary"
        (click)="onAddPlatform()"
        aria-label="Add platform"
      >
        <mat-icon class="!text-white">add</mat-icon>
        Add Platform
      </button>
    </div>

    <div class="table-wrapper hidden md:block">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Margin %</th>
            <th>Extra flat margin</th>
            <th>Ebook</th>
            <th>Only Inventory</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          @if (platforms().length) {
            @for (platform of platforms(); track platform.id) {
              <tr>
                <td>{{ platform.name }}</td>
                <td>{{ platform.marginPercent }}%</td>
                <td>{{ platform.extraFlatMargin || 0 }}</td>
                <td>{{ platform.isEbookPlatform ? "Yes" : "No" }}</td>
                <td>{{ platform.isInventoryPlatform ? "Yes" : "No" }}</td>
                <td>
                  <button
                    type="button"
                    matButton="filled"
                    class="hover:!bg-primary/80"
                    (click)="onEditPlatform(platform)"
                  >
                    <mat-icon>edit</mat-icon>
                    Edit
                  </button>
                </td>
              </tr>
            }
          } @else {
            <tr>
              <td colspan="6" class="empty-state">
                No platforms found. Add your first platform above.
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
    <!-- ================= MOBILE CARDS ================= -->
    <div class="md:hidden space-y-4">
      @if (platforms().length) {
        @for (platform of platforms(); track platform.id) {
          <div class="platform-card">
            <div class="platform-card-header">
              <h3 class="platform-name">{{ platform.name }}</h3>
              <button
                mat-icon-button
                class="btn-primary-icon"
                (click)="onEditPlatform(platform)"
              >
                <mat-icon>edit</mat-icon>
              </button>
            </div>

            <div class="platform-card-grid">
              <div>
                <span class="label">Margin %</span>
                <span>{{ platform.marginPercent }}%</span>
              </div>

              <div>
                <span class="label">Extra flat margin</span>
                <span>{{ platform.extraFlatMargin || 0 }}</span>
              </div>

              <div>
                <span class="label">Ebook</span>
                <span>{{ platform.isEbookPlatform ? "Yes" : "No" }}</span>
              </div>

              <div>
                <span class="label">Only Inventory</span>
                <span>{{ platform.isInventoryPlatform ? "Yes" : "No" }}</span>
              </div>
            </div>
          </div>
        }
      } @else {
        <p class="empty-state">
          No platforms found. Add your first platform above.
        </p>
      }
    </div>
  </section>
}
