<form
  class="flex flex-col gap-6 max-w-[95vw] p-6"
  [formGroup]="form"
  (ngSubmit)="onSubmit()"
>
  <!-- Header Section -->
  <div
    class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 pb-4 border-b border-gray-200"
  >
    <div>
      <h2 mat-dialog-title class="text-2xl font-bold text-gray-800 mb-1">
        Create Sales
      </h2>
      <p class="text-sm text-gray-500">Add new sales records for titles</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <button
        mat-raised-button
        type="button"
        [color]="lastSelectedSaleType === salesTypes.SALE ? 'primary' : ''"
        [class.mat-primary]="lastSelectedSaleType === salesTypes.SALE"
        [class.bg-gray-100]="lastSelectedSaleType !== salesTypes.SALE"
        [class.text-gray-700]="lastSelectedSaleType !== salesTypes.SALE"
        (click)="selectSaleType(salesTypes.SALE)"
        class="!min-w-[120px]"
      >
        <mat-icon class="!text-lg !mr-1">shopping_cart</mat-icon>
        Sale
      </button>
      <button
        mat-raised-button
        type="button"
        [color]="lastSelectedSaleType === salesTypes.LIVE_SALE ? 'primary' : ''"
        [class.mat-primary]="lastSelectedSaleType === salesTypes.LIVE_SALE"
        [class.bg-gray-100]="lastSelectedSaleType !== salesTypes.LIVE_SALE"
        [class.text-gray-700]="lastSelectedSaleType !== salesTypes.LIVE_SALE"
        (click)="selectSaleType(salesTypes.LIVE_SALE)"
        class="!min-w-[120px]"
      >
        <mat-icon class="!text-lg !mr-1">flash_on</mat-icon>
        Live Sale
      </button>
      <button
        mat-raised-button
        type="button"
        [color]="lastSelectedSaleType === salesTypes.INVENTORY ? 'primary' : ''"
        [class.mat-primary]="lastSelectedSaleType === salesTypes.INVENTORY"
        [class.bg-gray-100]="lastSelectedSaleType !== salesTypes.INVENTORY"
        [class.text-gray-700]="lastSelectedSaleType !== salesTypes.INVENTORY"
        (click)="selectSaleType(salesTypes.INVENTORY)"
        class="!min-w-[120px]"
      >
        <mat-icon class="!text-lg !mr-1">inventory</mat-icon>
        Inventory
      </button>
    </div>
  </div>

  <mat-dialog-content class="!max-h-[70vh] !overflow-y-auto">
    <div class="flex flex-col gap-6">
      @for (saleGroup of form.controls.salesArray.controls; track $index) {
      <mat-card
        class="!shadow-md !rounded-lg !border !border-gray-200 hover:!shadow-lg transition-shadow"
      >
        <mat-card-header class="!pb-3 !border-b !border-gray-100">
          <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-3">
              <mat-icon
                [class.text-primary]="saleGroup.controls.type.value === 'SALE'"
                [class.text-orange-500]="
                  saleGroup.controls.type.value === 'LIVE_SALE'
                "
                [class.text-purple-500]="
                  saleGroup.controls.type.value === 'INVENTORY'
                "
                class="!text-2xl"
              >
                @if (saleGroup.controls.type.value === 'SALE') { shopping_cart }
                @else if (saleGroup.controls.type.value === 'LIVE_SALE') {
                flash_on } @else { inventory }
              </mat-icon>
              <div>
                <mat-card-title class="!text-lg !mb-0">
                  {{ saleGroup.controls.type.value | translate }}
                </mat-card-title>
                <mat-card-subtitle class="!text-xs !mt-1">
                  Sale Entry #{{ $index + 1 }}
                </mat-card-subtitle>
              </div>
            </div>
            @if (form.controls.salesArray.controls.length > 1) {
            <button
              mat-icon-button
              type="button"
              color="warn"
              (click)="form.controls.salesArray.removeAt($index)"
              [matTooltip]="'Remove this entry'"
              class="!text-red-500 hover:!bg-red-50"
            >
              <mat-icon>delete</mat-icon>
            </button>
            }
          </div>
        </mat-card-header>

        <mat-card-content class="!pt-6">
          <div
            class="grid gap-4"
            [ngClass]="{
              'grid-cols-1 md:grid-cols-4':
                saleGroup.controls.type.value === 'INVENTORY' ||
                saleGroup.controls.type.value === 'LIVE_SALE',
              'grid-cols-1 md:grid-cols-2 lg:grid-cols-3':
                saleGroup.controls.type.value === 'SALE'
            }"
          >
            <!-- Title Field -->
            <mat-form-field appearance="outline" class="!w-full">
              <mat-label>Title</mat-label>
              <mat-select [formControl]="saleGroup.controls.title.controls.id">
                <mat-option [value]="null" disabled>Select a title</mat-option>
                @for (title of titles() |
                myTitleFilterBySale:saleGroup.controls.title.controls.availableOptions.value;
                track title.id) {
                <mat-option [value]="title.id">{{ title.name }}</mat-option>
                }
              </mat-select>
              <mat-icon matPrefix class="!text-gray-400 !mr-2">book</mat-icon>
              @if (saleGroup.controls.title.controls.id.hasError('required') &&
              saleGroup.controls.title.controls.id.touched) {
              <mat-error>Title is required</mat-error>
              }
            </mat-form-field>

            <!-- Platform Field -->
            <mat-form-field appearance="outline" class="!w-full">
              <mat-label>Platform</mat-label>
              <mat-select
                [formControl]="saleGroup.controls.platform"
                [disabled]="!saleGroup.controls.title.controls.id.value"
              >
                <mat-option [value]="null" disabled
                  >Select a platform</mat-option
                >
                @for (platform of
                getAvailablePlatformsForTitle(saleGroup.controls.title.controls.id.value);
                track platform) {
                <mat-option [value]="platform">{{
                  platform | translate
                }}</mat-option>
                }
              </mat-select>
              <mat-icon matPrefix class="!text-gray-400 !mr-2">store</mat-icon>
              @if (saleGroup.controls.platform.hasError('required') &&
              saleGroup.controls.platform.touched) {
              <mat-error>Platform is required</mat-error>
              } @if (!saleGroup.controls.title.controls.id.value) {
              <mat-hint>Please select a title first</mat-hint>
              }
            </mat-form-field>

            <!-- Amount Field (Only for INVENTORY) -->
            @if (saleGroup.controls.type.value === 'INVENTORY') {
            <mat-form-field appearance="outline" class="!w-full">
              <mat-label>Amount</mat-label>
              <input
                matInput
                type="number"
                [formControl]="saleGroup.controls.amount"
                placeholder="Enter amount"
                min="0"
                step="0.01"
              />
              <mat-icon matPrefix class="!text-gray-400 !mr-2"
                >currency_rupee</mat-icon
              >
              <span matSuffix class="!text-gray-500">â‚¹</span>
              @if (saleGroup.controls.amount.hasError('required') &&
              saleGroup.controls.amount.touched) {
              <mat-error>Amount is required</mat-error>
              } @if (saleGroup.controls.amount.hasError('min') &&
              saleGroup.controls.amount.touched) {
              <mat-error>Amount must be greater than 0</mat-error>
              }
            </mat-form-field>
            }

            <!-- Quantity Field -->
            <mat-form-field appearance="outline" class="!w-full">
              <mat-label>Quantity</mat-label>
              <input
                matInput
                type="number"
                [formControl]="saleGroup.controls.quantity"
                placeholder="Enter quantity"
                min="1"
              />
              <mat-icon matPrefix class="!text-gray-400 !mr-2"
                >numbers</mat-icon
              >
              @if (saleGroup.controls.quantity.hasError('required') &&
              saleGroup.controls.quantity.touched) {
              <mat-error>Quantity is required</mat-error>
              } @if (saleGroup.controls.quantity.hasError('min') &&
              saleGroup.controls.quantity.touched) {
              <mat-error>Quantity must be at least 1</mat-error>
              }
            </mat-form-field>

            <!-- Sold At Field (Only for LIVE_SALE) -->
            @if (saleGroup.controls.type.value !== 'INVENTORY' &&
            saleGroup.controls.type.value !== 'SALE') {
            <mat-form-field appearance="outline" class="!w-full">
              <mat-label>Sold At</mat-label>
              <input
                matInput
                readonly
                (focus)="picker.open()"
                (click)="picker.open()"
                [value]="
                  saleGroup.controls.soldAt.value | myDate : 'dd-MM-yyyy'
                "
                placeholder="Select date"
              />
              <mat-icon matPrefix class="!text-gray-400 !mr-2"
                >calendar_today</mat-icon
              >
              <input
                class="opacity-0 absolute top-0 left-0 w-0 h-0"
                matInput
                [ngxMatDatetimePicker]="picker"
                [formControl]="saleGroup.controls.soldAt"
                tabindex="-1"
              />
              <ngx-mat-datetime-picker #picker>
                <ngx-mat-datepicker-actions>
                  <div class="flex justify-between w-full px-4 py-2">
                    <button mat-button ngxMatDatepickerCancel>Cancel</button>
                    <button
                      mat-raised-button
                      color="primary"
                      ngxMatDatepickerApply
                    >
                      Apply
                    </button>
                  </div>
                </ngx-mat-datepicker-actions>
              </ngx-mat-datetime-picker>
            </mat-form-field>
            }
          </div>
        </mat-card-content>
      </mat-card>
      } @if (form.controls.salesArray.controls.length === 0) {
      <div
        class="text-center py-12 border-2 border-dashed border-gray-300 rounded-lg"
      >
        <mat-icon class="!text-6xl !text-gray-400 !mb-4"
          >add_shopping_cart</mat-icon
        >
        <p class="text-gray-500 text-lg font-medium mb-2">
          No sales entries yet
        </p>
        <p class="text-gray-400 text-sm">
          Click on a sale type button above to get started
        </p>
      </div>
      }
    </div>
  </mat-dialog-content>
  <mat-dialog-actions
    class="!px-0 !pb-0 !pt-4 !mt-4 !border-t !border-gray-200"
  >
    <div
      class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 w-full"
    >
      <button
        type="button"
        mat-stroked-button
        color="primary"
        (click)="addMoreSales()"
        [disabled]="!lastSelectedSaleType"
        class="!min-w-[140px]"
      >
        <mat-icon class="!mr-1">add_circle</mat-icon>
        Add Another
      </button>

      <div class="flex gap-3">
        <button
          type="button"
          mat-stroked-button
          (click)="data.onClose()"
          class="!min-w-[100px]"
        >
          Cancel
        </button>
        <button
          type="submit"
          mat-raised-button
          color="primary"
          [disabled]="
            !form.valid || form.controls.salesArray.controls.length === 0
          "
          class="!min-w-[120px]"
        >
          <mat-icon class="!mr-1">check_circle</mat-icon>
          Submit Sales
        </button>
      </div>
    </div>
  </mat-dialog-actions>
</form>
