<form
  class="flex flex-col gap-3 max-w-[95vw] p-4"
  [formGroup]="form"
  (ngSubmit)="onSubmit()"
  style="max-height: 90vh"
>
  <!-- Header Section -->
  <div
    class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 pb-2 border-b border-gray-200"
  >
    <div>
      <h2 mat-dialog-title class="text-xl font-bold text-gray-800 mb-0">
        Create Sales
      </h2>
    </div>
    <div class="flex flex-wrap gap-2">
      <button
        mat-raised-button
        type="button"
        [color]="lastSelectedSaleType === salesTypes.SALE ? 'primary' : ''"
        [class.mat-primary]="lastSelectedSaleType === salesTypes.SALE"
        [class.bg-gray-100]="lastSelectedSaleType !== salesTypes.SALE"
        [class.text-gray-700]="lastSelectedSaleType !== salesTypes.SALE"
        (click)="selectSaleType(salesTypes.SALE)"
        class="!min-w-[120px]"
      >
        <mat-icon class="!text-lg !mr-1">shopping_cart</mat-icon>
        Sale
      </button>
      <button
        mat-raised-button
        type="button"
        [color]="lastSelectedSaleType === salesTypes.LIVE_SALE ? 'primary' : ''"
        [class.mat-primary]="lastSelectedSaleType === salesTypes.LIVE_SALE"
        [class.bg-gray-100]="lastSelectedSaleType !== salesTypes.LIVE_SALE"
        [class.text-gray-700]="lastSelectedSaleType !== salesTypes.LIVE_SALE"
        (click)="selectSaleType(salesTypes.LIVE_SALE)"
        class="!min-w-[120px]"
      >
        <mat-icon class="!text-lg !mr-1">flash_on</mat-icon>
        Live Sale
      </button>
      <button
        mat-raised-button
        type="button"
        [color]="lastSelectedSaleType === salesTypes.INVENTORY ? 'primary' : ''"
        [class.mat-primary]="lastSelectedSaleType === salesTypes.INVENTORY"
        [class.bg-gray-100]="lastSelectedSaleType !== salesTypes.INVENTORY"
        [class.text-gray-700]="lastSelectedSaleType !== salesTypes.INVENTORY"
        (click)="selectSaleType(salesTypes.INVENTORY)"
        class="!min-w-[120px]"
      >
        <mat-icon class="!text-lg !mr-1">inventory</mat-icon>
        Inventory
      </button>
    </div>
  </div>

  <mat-dialog-content class="!max-h-[calc(90vh-200px)] !overflow-y-auto !p-0">
    <div class="flex flex-col gap-2">
      @for (saleGroup of form.controls.salesArray.controls; track $index) {
      <mat-card class="!shadow-sm !rounded-md !border !border-gray-200">
        <mat-card-content class="!p-3 !pb-2">
          <div class="flex items-center gap-2 flex-wrap lg:flex-nowrap">
            <!-- Title Field -->
            <mat-form-field
              appearance="outline"
              class="!w-auto !min-w-[200px] !flex-1"
            >
              <mat-icon matPrefix class="!text-gray-400 !mr-2 !text-lg"
                >book</mat-icon
              >
              <mat-select
                [formControl]="saleGroup.controls.title.controls.id"
                placeholder="Select Title"
              >
                <mat-option [value]="null" disabled>Select a title</mat-option>
                @for (title of titles() |
                myTitleFilterBySale:saleGroup.controls.title.controls.availableOptions.value;
                track title.id) {
                <mat-option [value]="title.id">{{ title.name }}</mat-option>
                }
              </mat-select>
              @if (saleGroup.controls.title.controls.id.hasError('required') &&
              saleGroup.controls.title.controls.id.touched) {
              <mat-error>Required</mat-error>
              }
            </mat-form-field>

            <!-- Platform Field -->
            <mat-form-field
              appearance="outline"
              class="!w-auto !min-w-[150px] !flex-1"
            >
              <mat-icon matPrefix class="!text-gray-400 !mr-2 !text-lg"
                >store</mat-icon
              >
              <mat-select
                [formControl]="saleGroup.controls.platform"
                [disabled]="!saleGroup.controls.title.controls.id.value"
                placeholder="Select Platform"
              >
                <mat-option [value]="null" disabled>Select platform</mat-option>
                @for (platform of
                getAvailablePlatformsForTitle(saleGroup.controls.title.controls.id.value);
                track platform) {
                <mat-option [value]="platform">{{
                  platform | translate
                }}</mat-option>
                }
              </mat-select>
              @if (saleGroup.controls.platform.hasError('required') &&
              saleGroup.controls.platform.touched) {
              <mat-error>Required</mat-error>
              }
            </mat-form-field>

            <!-- Amount Field (Only for INVENTORY) -->
            @if (saleGroup.controls.type.value === 'INVENTORY') {
            <mat-form-field appearance="outline" class="!w-auto !min-w-[120px]">
              <mat-icon matPrefix class="!text-gray-400 !mr-2 !text-lg"
                >currency_rupee</mat-icon
              >
              <input
                matInput
                type="number"
                [formControl]="saleGroup.controls.amount"
                placeholder="Amount"
                min="0"
                step="0.01"
              />
              <span matSuffix class="!text-gray-500">₹</span>
              @if (saleGroup.controls.amount.hasError('required') &&
              saleGroup.controls.amount.touched) {
              <mat-error>Required</mat-error>
              }
            </mat-form-field>
            }

            <!-- Quantity Field -->
            <mat-form-field appearance="outline" class="!w-auto !min-w-[100px]">
              <mat-icon matPrefix class="!text-gray-400 !mr-2 !text-lg"
                >numbers</mat-icon
              >
              <input
                matInput
                type="number"
                [formControl]="saleGroup.controls.quantity"
                placeholder="Quantity"
                min="1"
              />
              @if (saleGroup.controls.quantity.hasError('required') &&
              saleGroup.controls.quantity.touched) {
              <mat-error>Required</mat-error>
              }
            </mat-form-field>

            <!-- Sold At Field (Only for LIVE_SALE) -->
            @if (saleGroup.controls.type.value !== 'INVENTORY' &&
            saleGroup.controls.type.value !== 'SALE') {
            <mat-form-field appearance="outline" class="!w-auto !min-w-[150px]">
              <mat-icon matPrefix class="!text-gray-400 !mr-2 !text-lg"
                >calendar_today</mat-icon
              >
              <input
                matInput
                readonly
                (focus)="picker.open()"
                (click)="picker.open()"
                [value]="
                  saleGroup.controls.soldAt.value | myDate : 'dd-MM-yyyy'
                "
                placeholder="Sold At"
              />
              <input
                class="opacity-0 absolute top-0 left-0 w-0 h-0"
                matInput
                [ngxMatDatetimePicker]="picker"
                [formControl]="saleGroup.controls.soldAt"
                tabindex="-1"
              />
              <ngx-mat-datetime-picker #picker>
                <ngx-mat-datepicker-actions>
                  <div class="flex justify-between w-full px-4 py-2">
                    <button mat-button ngxMatDatepickerCancel>Cancel</button>
                    <button
                      mat-raised-button
                      color="primary"
                      ngxMatDatepickerApply
                    >
                      Apply
                    </button>
                  </div>
                </ngx-mat-datepicker-actions>
              </ngx-mat-datetime-picker>
            </mat-form-field>
            } @if (form.controls.salesArray.controls.length > 1) {
            <button
              mat-icon-button
              type="button"
              color="warn"
              (click)="removeSale($index)"
              [matTooltip]="'Remove'"
              class="!text-red-500 !h-10 !w-10"
            >
              <mat-icon class="!text-lg">delete</mat-icon>
            </button>
            }
          </div>
        </mat-card-content>
      </mat-card>
      } @if (form.controls.salesArray.controls.length === 0) {
      <div
        class="text-center py-12 border-2 border-dashed border-gray-300 rounded-lg"
      >
        <mat-icon class="!text-6xl !text-gray-400 !mb-4"
          >add_shopping_cart</mat-icon
        >
        <p class="text-gray-500 text-lg font-medium mb-2">
          No sales entries yet
        </p>
        <p class="text-gray-400 text-sm">
          Click on a sale type button above to get started
        </p>
      </div>
      }
    </div>
  </mat-dialog-content>
  <mat-dialog-actions
    class="!px-0 !pb-0 !pt-4 !mt-4 !border-t !border-gray-200"
  >
    <div class="flex items-center justify-between gap-4 w-full">
      <!-- Summary Section -->
      <div class="flex items-center gap-4 text-sm text-gray-600">
        @if (form.controls.salesArray.controls.length > 0) {
        <div class="flex items-center gap-2">
          <mat-icon class="!text-base !text-gray-500">shopping_cart</mat-icon>
          <span class="font-medium">{{ totalQuantity() }}</span>
          <span class="text-gray-500">items</span>
        </div>

        <div class="flex items-center gap-2">
          <mat-icon class="!text-base !text-gray-500">category</mat-icon>
          <span class="font-medium">
            @for (summary of salesSummary(); track summary.type) {
            {{ summary.count }} {{ summary.type | translate }}
            @if (!$last) {, } }
          </span>
        </div>

        @if (totalAmount() > 0) {
        <div class="flex items-center gap-2">
          <mat-icon class="!text-base !text-gray-500">currency_rupee</mat-icon>
          <span class="font-medium">{{ totalAmount().toFixed(2) }}</span>
          <span class="text-gray-500">₹</span>
        </div>
        } }
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-3">
        <button
          type="button"
          mat-stroked-button
          (click)="data.onClose()"
          class="!min-w-[100px]"
        >
          Cancel
        </button>
        <button
          type="submit"
          mat-raised-button
          color="primary"
          [disabled]="
            !form.valid || form.controls.salesArray.controls.length === 0
          "
          class="!min-w-[120px]"
        >
          <mat-icon class="!mr-1">check_circle</mat-icon>
          Submit Sales
        </button>
      </div>
    </div>
  </mat-dialog-actions>
</form>
